"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const dataloader_1 = __importDefault(require("dataloader"));
const ramda_1 = require("ramda");
const sortByContent = (indexedMessages) => ramda_1.sortBy(([_, message]) => message.content, indexedMessages);
const sortByIndex = (indexedTranslations) => ramda_1.sortBy(([index, _]) => Number(index), indexedTranslations);
const toInput = (messages) => ramda_1.map((message) => ({
    behavior: message.behavior,
    content: message.content,
    context: message.context,
}), messages);
exports.messagesLoaderV2 = (clients) => new dataloader_1.default(async (messages) => {
    const to = messages[0].to;
    const from = messages[0].from;
    const indexedMessages = ramda_1.toPairs(messages);
    const sortedIndexedMessages = sortByContent(indexedMessages);
    const originalIndexes = ramda_1.pluck(0, sortedIndexedMessages);
    const sortedMessages = ramda_1.pluck(1, sortedIndexedMessages);
    const translations = await clients.messagesGraphQL.translateV2({
        from,
        messages: toInput(sortedMessages),
        to,
    });
    const indexedTranslations = ramda_1.zip(originalIndexes, translations);
    const translationsInOriginalOrder = sortByIndex(indexedTranslations);
    return ramda_1.pluck(1, translationsInOriginalOrder);
});
